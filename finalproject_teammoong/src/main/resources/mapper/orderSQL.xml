<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN
" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="order">

<!-- 주문서 페이지에서 회원에게 보여질 쿠폰 리스트 (규린) -->
	<select id="selectMemberCouponList" parameterType="_int" resultType="ic">
       select
       		issue_no AS issueNo,
            coupon_title AS couponTitle,
            coupon_price AS couponPrice,
             TO_CHAR(end_date, 'YYYY-MM-DD') AS endDate
       from issue_coupon
       left join coupon_tbl using (coupon_no)
       where member_no = #{_parameter}
       order by 1 desc
	</select>
	<select id="selectMemberCouponCount" parameterType="_int" resultType="_int">
		 select count(*) AS couponCount from ISSUE_COUPON where member_no=#{_parameter}
	</select>
	<select id="selectOrderProductList" parameterType="map" resultType="o">
		select
			p.product_no AS productNo,
			(SELECT FILEPATH FROM PRODUCT_IMG WHERE P_IMG_NO=(SELECT MIN(P_IMG_NO) FROM PRODUCT_IMG where product_no=p.product_no)) AS thumbnail,
			p.product_name AS productName,
			p.product_price AS productPrice,
			p.PRODUCT_COST AS productCost,
			p.product_discount AS productDiscount,
			oi.option_info_no AS optionNo,
			oi.option_dateail AS optionDetailName
		<if test="page == 0">
			,b.basket_count AS basketCount
		</if>
		from product_tbl p
		left join OPTION_GROUP_TBL og on p.product_no = og.product_no
		left join OPTION_INFO_TBL oi on OG.OPTION_GROUP_NO = OI.OPTION_GROUP_NO
		<if test="page == 0">
		left join basket_tbl b on p.product_no = b.product_no
		</if>
		where p.product_no=#{productNo} 
		<if test="page == 0">
		and b.member_no = #{memberNo}
		</if>
		<if test="optionNo != 0">
		and oi.option_info_no = #{optionNo}
		</if>
		<if test="page == 0">
			<if test="optionNo != 0">
				 and b.basket_no = #{basketNo}
			</if>
		</if>
	</select>
	
	<select id="selectMoongsanOrderProductList" parameterType="map" resultType="o">
		select
			p.product_no AS productNo,
			(SELECT FILEPATH FROM PRODUCT_IMG WHERE P_IMG_NO=(SELECT MIN(P_IMG_NO) FROM PRODUCT_IMG where product_no=p.product_no)) AS thumbnail,
			p.product_name AS productName,
			p.product_price AS productPrice,
			p.PRODUCT_COST AS productCost,
			p.product_discount AS productDiscount,
			oi.option_info_no AS optionNo,
			oi.option_dateail AS optionDetailName			
		from product_tbl p
		left join OPTION_GROUP_TBL og on p.product_no = og.product_no
		left join OPTION_INFO_TBL oi on OG.OPTION_GROUP_NO = OI.OPTION_GROUP_NO
		where p.product_no=#{productNo}
		<if test="optionNo != 0">
		and option_info_no = #{optionNo}
		</if>
	</select>
	
	<insert id="insertOrder" parameterType="o">
		insert into order_tbl values
		(order_tbl_seq.nextval, #{memberNo}, #{productNo}, sysdate, 1, #{totalPrice}, #{deliReceiver}, #{deliPhone}, #{deliAddr1}, #{deliRequest})
		<selectKey resultType="_int" order="AFTER" keyProperty="orderNo">
			select max(order_no) from order_tbl
		</selectKey>
	</insert>
	
	<select id="selectMaxOrderNo" resultType="_int">
		select max(order_no) from order_tbl
	</select>
	
	<select id="selectBasketNo" parameterType="map" resultType="_int">
        select 
       		b.basket_no as basketNo
        from basket_tbl b left join basket_option_tbl bo on b.basket_no = bo.basket_no
        where b.member_no = #{memberNo} and b.product_no=#{productNo} and bo.option_info_no=#{optionNo}
	</select>
	

</mapper>
