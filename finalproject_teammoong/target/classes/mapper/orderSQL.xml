<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN
" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="order">

<!-- 주문서 페이지에서 회원에게 보여질 쿠폰 리스트 (규린) -->
	<select id="selectMemberCouponList" parameterType="_int" resultType="ic">
       select
            coupon_title AS couponTitle,
            coupon_price AS couponPrice,
             TO_CHAR(end_date, 'YYYY-MM-DD') AS endDate
       from issue_coupon
       left join coupon_tbl using (coupon_no)
       where member_no = #{_parameter}
       order by 1 desc
	</select>
	<select id="selectMemberCouponCount" parameterType="_int" resultType="_int">
		 select count(*) AS couponCount from ISSUE_COUPON where member_no=#{_parameter}
	</select>
	<select id="selectOrderProductList" parameterType="map" resultType="o">
		select
			p.product_no AS productNo,
			(SELECT FILEPATH FROM PRODUCT_IMG WHERE P_IMG_NO=(SELECT MIN(P_IMG_NO) FROM PRODUCT_IMG where product_no=p.product_no)) AS thumbnail,
			p.product_name AS productName,
			p.product_price AS productPrice,
			p.product_discount AS productDiscount,
			oi.option_info_no AS optionNo,
			oi.option_dateail AS optionDetailName,
			b.basket_count AS basketCount
		from product_tbl p
		left join OPTION_GROUP_TBL og on p.product_no = og.product_no
		left join OPTION_INFO_TBL oi on OG.OPTION_GROUP_NO = OI.OPTION_GROUP_NO
		left join basket_tbl b on p.product_no = b.product_no
		where p.product_no=#{productNo}
		<if test="optionNo != 0">
		and option_info_no = #{optionNo}
		</if>
	</select>
	<insert id="insertOrder" parameterType="pay">
		insert into order_tbl values
		(order_seq.nextval, #{memberNo}, #{productNo}, #{payNo}, sysdate, 1)
		<selectKey resultType="_int" order="AFTER" keyProperty="orderNo">
			select max(order_no) from order_tbl
		</selectKey>
	</insert>

</mapper>
